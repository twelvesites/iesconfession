<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - IES Confessions</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; padding: 20px; margin:0; }
    h1, h2 { text-align: center; margin: 10px 0; }
    .stats-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
    .stat-box { background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center; min-width: 150px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .stat-box strong { font-size: 18px; color: #e11d48; display:block; margin-bottom:5px; }
    .confession-box, .visitor-box { background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px; border-left: 6px solid red; }
    .confession-text { font-size: 16px; margin-bottom: 10px; font-weight: bold; }
    .meta { font-size: 14px; color: #333; margin-top: 5px; }
    .meta strong { color: #e11d48; }
    .meta-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
    .meta button { background: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    .meta button:hover { background: darkred; }
    pre { font-size:13px; background:#f1f1f1; padding:8px; border-radius:5px; overflow-x:auto; }
  </style>
</head>
<body>

<h1>üö® Admin Dashboard - TWELVE</h1>

<div class="stats-container">
  <div class="stat-box"><strong id="totalConfessions">0</strong>Total Confessions</div>
  <div class="stat-box"><strong id="totalFeedbacks">0</strong>Total Feedbacks</div>
  <div class="stat-box"><strong id="totalVisitors">0</strong>Total Visitors</div>
  <div class="stat-box"><strong id="avgVisitors">0</strong>Avg Visitors/Day</div>
  <div class="stat-box"><strong id="recentVisitor">N/A</strong>Most Recent Visitor</div>
</div>

<h2>üì¢ Confessions</h2>
<div id="adminFeed"></div>

<h2>üë• Visitor Analytics</h2>
<div id="adminVisitors"></div>

<script type="module">
  // Remove all Firebase client-side imports as the backend will handle database access
  
  // ---------------- API CONFIGURATION ----------------
  const API_URL = "https://iestea-backend.vercel.app/api/confess";
  const ORIGIN_SECRET = "f1b2c3d4e5f67890123456789abcdef0123456789abcdef0123456789abcdef";

  // ---------------- DOM ELEMENTS ----------------
  const totalConfessionsEl = document.getElementById('totalConfessions');
  const totalVisitorsEl = document.getElementById('totalVisitors');
  const avgVisitorsEl = document.getElementById('avgVisitors');
  const recentVisitorEl = document.getElementById('recentVisitor');
  const adminFeed = document.getElementById('adminFeed');
  const adminVisitorsContainer = document.getElementById('adminVisitors');

  // ---------------- HELPERS ----------------
  function escapeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatTimestamp(ts) {
    if (!ts) return "Unknown";
    return new Date(ts).toLocaleString();
  }

  // ---------------- Confession Functions ----------------
  async function fetchConfessions() {
    try {
      const response = await fetch(API_URL, {
        method: "GET",
        headers: {
          "x-origin-secret": ORIGIN_SECRET
        }
      });
      const data = await response.json();
      if (data.ok) {
        return data.confessions.map(c => ({ id: c.id, ...c.data }));
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      console.error("Error fetching confessions from API:", error);
      throw error;
    }
  }

  function renderAdminCard(id, data) {
    const { text, createdAt, userId, reports, language, platform, userAgent, likes, replies, deviceInfo = {} } = data;
    const box = document.createElement('div');
    box.className = 'confession-box';
    box.innerHTML = `
      <div class="confession-text">${escapeHTML(text || "[No Text]")}</div>
      <div class="meta"><strong>üìÖ Submitted:</strong> ${formatTimestamp(createdAt)}</div>
      <div class="meta"><strong>üßë User ID:</strong> ${userId || "N/A"}</div>
      <div class="meta"><strong>‚ö†Ô∏è Reports:</strong> ${reports || 0}</div>
      <div class="meta"><strong>‚ù§Ô∏è Likes:</strong> ${likes || 0}</div>
      <div class="meta"><strong>üí¨ Replies:</strong> ${replies?.length || 0}</div>
      <div class="meta"><strong>üåê Language:</strong> ${language || "N/A"}</div>
      <div class="meta"><strong>üíª Platform:</strong> ${platform || "N/A"}</div>
      <div class="meta"><strong>üïµÔ∏è User Agent:</strong> ${userAgent || "N/A"}</div>
      <div class="meta"><strong>üì± Device Info:</strong><pre>${escapeHTML(JSON.stringify(deviceInfo, null, 2))}</pre></div>
      <div class="meta"><button onclick="deleteConfession('${id}', '${userId}')">üóëÔ∏èÔ∏è Delete Confession</button></div>
    `;
    adminFeed.appendChild(box);
  }

  window.deleteConfession = async function(id, userId) {
  if (!confirm("Delete this confession?")) return;
  try {
    const response = await fetch(API_URL, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "x-origin-secret": ORIGIN_SECRET
      },
      // Now including userId
      body: JSON.stringify({ id, userId }) 
    });
    const data = await response.json();
    if (data.ok) {
      loadConfessions();
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    console.error("Error deleting document via API:", error);
    alert("Error deleting: " + error.message);
  }
};

  async function loadConfessions() {
    adminFeed.innerHTML = "";
    try {
      const confessions = await fetchConfessions();
      confessions.forEach(c => renderAdminCard(c.id, c));
      totalConfessionsEl.textContent = confessions.length;
    } catch (error) {
      console.error("Error loading confessions:", error);
      totalConfessionsEl.textContent = "Error";
      adminFeed.innerHTML = `<p style="color:red;">Error: Failed to load data from backend. Please check the API URL and secret.</p>`;
    }
  }

  // ---------------- Visitor Functions ----------------
  // Note: Your backend API does not have an endpoint for visitor data.
  // This function will fail until you create one.
  async function loadVisitors() {
    adminVisitorsContainer.innerHTML = `<p>Visitor data is not available. A backend endpoint is needed.</p>`;
    totalVisitorsEl.textContent = "N/A";
    avgVisitorsEl.textContent = "N/A";
    recentVisitorEl.textContent = "N/A";
  }

  // ---------------- INIT ----------------
  // Directly call the load functions
  loadConfessions();
  loadVisitors();
</script>

</body>
</html>
